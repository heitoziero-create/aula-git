#include <WiFiS3.h>       // Biblioteca para WiFi no Uno R4 WiFi
#include <WiFiUdp.h>
#include <NTPClient.h>
#include <Servo.h>

// ======= CONFIGURAÇÕES =======
const char* ssid     = "GalaxyS23Fe";     // coloque o nome da sua rede WiFi
const char* password = "12345678";    // coloque a senha da sua rede

// Horários de alimentação (formato 24h)
int horarios[][2] = {
  {19,  0},   // 08:00
  {19, 02},   // 14:00
  {19, 05},    // 20:00
  {19, 07},   // 08:00
  {19, 10},   // 08:00
  {19, 12},   // 08:00
  {19, 15},   // 08:00
  {19, 17},   // 08:00
  {19, 20},   // 08:00
  {19, 22},   // 08:00
  {19, 25},   // 08:00
  {19, 27},   // 08:00
  {19, 30},   // 08:00
  {19, 32},   // 08:00
  {19, 35},   // 08:00
  {19, 37},   // 08:00
  {19, 40},   // 08:00
  {19, 42},   // 08:00
  {19, 45},   // 08:00
  {19, 47},   // 08:00
  {19, 50},   // 08:00
  {19, 52},   // 08:00
  {19, 55},   // 08:00
  {19, 57},   // 08:00
  {20, 0},   // 08:00
  {20, 02},
  {20, 05},
  {20, 07},
  {20, 10},
  {20, 12},
  {20, 15},
  {20, 17},
  {20, 20},
  {20, 22},
  {20, 25},
  {20, 27},
  {20, 30},
  {20, 32},
  {20, 35},
  {20, 40},
  {21, 51},
};
int totalHorarios = 41;

// Tempo de abertura da comporta (em segundos)
const int tempoAberto = 15;

// Servo
const int servoPin = 9;
const int posFechado = 0;
const int posAberto  = 90;
Servo feederServo;

// Controle de horário
WiFiUDP ntpUDP;
NTPClient timeClient(ntpUDP, "pool.ntp.org", -3 * 3600); 
// Ajuste para seu fuso horário (-3h = Brasil)

// Para evitar múltiplas ativações no mesmo minuto
int ultimoMinutoAcionado = -1;

void setup() {
  Serial.begin(9600);

  // Conectar ao WiFi
  Serial.print("Conectando ao WiFi: ");
  Serial.println(ssid);
  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("\nWiFi conectado!");

  // Iniciar NTP
  timeClient.begin();

  // Servo
  feederServo.attach(servoPin);
  feederServo.write(posFechado);
  Serial.println("Alimentador automático iniciado.");
}

void loop() {
  timeClient.update();

  int hora = timeClient.getHours();
  int minuto = timeClient.getMinutes();

  // Verifica cada horário configurado
  for (int i = 0; i < totalHorarios; i++) {
    if (hora == horarios[i][0] && minuto == horarios[i][1]) {
      if (minuto != ultimoMinutoAcionado) {
        liberarRacao();
        ultimoMinutoAcionado = minuto; // evita múltiplas ativações no mesmo minuto
      }
    }
  }

  delay(1000); // evita uso excessivo da CPU
}

// Função para abrir e fechar a comporta
void liberarRacao() {
  Serial.println("Liberando ração...");
  feederServo.write(posAberto);
  delay(tempoAberto * 1000);
  feederServo.write(posFechado);
  Serial.println("Comporta fechada.");
}